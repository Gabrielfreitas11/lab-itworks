(()=>{var e={997:e=>{e.exports={codes:{33:"!",34:'"',35:"#",36:"$",37:"%",38:"&",39:"'",40:"(",41:")",42:"*",43:"+",44:",",45:"-",46:".",47:"/",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",58:":",59:";",60:"<",61:"=",62:">",63:"?",64:"@",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"[",92:"\\",93:"]",94:"^",95:"_",96:"`",97:"a",98:"b",99:"c",100:"d",101:"e",102:"f",103:"g",104:"h",105:"i",106:"j",107:"k",108:"l",109:"m",110:"n",111:"o",112:"p",113:"q",114:"r",115:"s",116:"t",117:"u",118:"v",119:"w",120:"x",121:"y",122:"z",123:"{",124:"|",125:"}",126:"~",127:" ",128:"€",129:" ",130:"‚",131:"ƒ",132:"„",133:"…",134:"†",135:"‡",136:"ˆ",137:"‰",138:"Š",139:"‹",140:"Œ",141:" ",142:"Ž",143:" ",144:" ",145:"‘",146:"’",147:"“",148:"”",149:"•",150:"–",151:"—",152:"˜",153:"™",154:"š",155:"›",156:"œ",157:" ",158:"ž",159:"Ÿ",160:" ",161:"¡",162:"¢",163:"£",164:"¤",165:"¥",166:"¦",167:"§",168:"¨",169:"©",170:"ª",171:"«",172:"¬",173:"�­",174:"®",175:"¯",176:"°",177:"±",178:"²",179:"³",180:"´",181:"µ",182:"¶",183:"·",184:"¸",185:"¹",186:"º",187:"»",188:"¼",189:"½",190:"¾",191:"¿",192:"À",193:"Á",194:"Â",195:"Ã",196:"Ä",197:"Å",198:"Æ",199:"Ç",200:"È",201:"É",202:"Ê",203:"Ë",204:"Ì",205:"Í",206:"Î",207:"Ï",208:"Ð",209:"Ñ",210:"Ò",211:"Ó",212:"Ô",213:"Õ",214:"Ö",215:"×",216:"Ø",217:"Ù",218:"Ú",219:"Û",220:"Ü",221:"Ý",222:"Þ",223:"ß",224:"à",225:"á",226:"â",227:"ã",228:"ä",229:"å",230:"æ",231:"ç",232:"è",233:"é",234:"ê",235:"ë",236:"ì",237:"í",238:"î",239:"ï",240:"ð",241:"ñ",242:"ò",243:"ó",244:"ô",245:"õ",246:"ö",247:"÷",248:"ø",249:"ù",250:"ú",251:"û",252:"ü",253:"ý",254:"þ",255:"ÿ"},reverseCodes:{"!":33,'"':34,"#":35,$:36,"%":37,"&":38,"'":39,"(":40,")":41,"*":42,"+":43,",":44,"-":45,".":46,"/":47,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,":":58,";":59,"<":60,"=":61,">":62,"?":63,"@":64,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,"[":91,"\\":92,"]":93,"^":94,_:95,"`":96,a:97,b:98,c:99,d:100,e:101,f:102,g:103,h:104,i:105,j:106,k:107,l:108,m:109,n:110,o:111,p:112,q:113,r:114,s:115,t:116,u:117,v:118,w:119,x:120,y:121,z:122,"{":123,"|":124,"}":125,"~":126," ":127,"€":128," ":129,"‚":130,ƒ:131,"„":132,"…":133,"†":134,"‡":135,ˆ:136,"‰":137,Š:138,"‹":139,Œ:140," ":141,Ž:142," ":143," ":144,"‘":145,"’":146,"“":147,"”":148,"•":149,"–":150,"—":151,"˜":152,"™":153,š:154,"›":155,œ:156," ":157,ž:158,Ÿ:159," ":160,"¡":161,"¢":162,"£":163,"¤":164,"¥":165,"¦":166,"§":167,"¨":168,"©":169,ª:170,"«":171,"¬":172,"�­":173,"®":174,"¯":175,"°":176,"±":177,"²":178,"³":179,"´":180,µ:181,"¶":182,"·":183,"¸":184,"¹":185,º:186,"»":187,"¼":188,"½":189,"¾":190,"¿":191,À:192,Á:193,Â:194,Ã:195,Ä:196,Å:197,Æ:198,Ç:199,È:200,É:201,Ê:202,Ë:203,Ì:204,Í:205,Î:206,Ï:207,Ð:208,Ñ:209,Ò:210,Ó:211,Ô:212,Õ:213,Ö:214,"×":215,Ø:216,Ù:217,Ú:218,Û:219,Ü:220,Ý:221,Þ:222,ß:223,à:224,á:225,â:226,ã:227,ä:228,å:229,æ:230,ç:231,è:232,é:233,ê:234,ë:235,ì:236,í:237,î:238,ï:239,ð:240,ñ:241,ò:242,ó:243,ô:244,õ:245,ö:246,"÷":247,ø:248,ù:249,ú:250,û:251,ü:252,ý:253,þ:254,ÿ:255}}},999:(e,r,t)=>{var{codes:n,reverseCodes:o}=t(997),a=function(e){var r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],t="",a=[77,84,79,65,73,78,67,70,82];return e.split("").forEach(((e,s)=>{var i=o[e];i>31&&(i-=32,i+=a[s%9]*(r?1:-1),(i%=224)<0&&(i=224+i),i+=32),t+=n[i]})),t};e.exports={encrypt:e=>a(e),decrypt:e=>a(e,!1)}}},r={};function t(n){var o=r[n];if(void 0!==o)return o.exports;var a=r[n]={exports:{}};return e[n](a,a.exports,t),a.exports}t.n=e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},t.d=(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},t.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),t.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};(()=>{"use strict";t.r(n),t.d(n,{downloadXML:()=>L,handle:()=>_});const e=require("@babel/runtime/helpers/asyncToGenerator");var r=t.n(e);class o{static ok(e){return{statusCode:200,body:e}}static created(e){return{statusCode:201,body:e}}static notFound(e){return{statusCode:404,body:e}}static badRequest(e){return{statusCode:400,body:e}}static serverError(e){return{statusCode:500,body:e}}}const a=require("@hapi/joi");var s=t.n(a),i=s().object({url:s().string().required(),key:s().string().required(),cnpj:s().string().required()});const u=require("@babel/runtime/helpers/defineProperty");var c=t.n(u);function l(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function p(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?l(Object(t),!0).forEach((function(r){c()(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}class d{constructor(){this.event=null,this.context=null,this.env=process.env}handle(e,t,n){var o=arguments,a=this;return r()((function*(){var r=!(o.length>3&&void 0!==o[3])||o[3];if(a.setFunctionContext(e,t),!(yield a.isAuthorized()))return d.httpResponse(401,JSON.stringify({statusCode:401,message:"Unauthorized!"}));try{var s=yield a[n](e);if(!r)return s;var i="string"==typeof s.body?s.body:JSON.stringify(s.body);return d.httpResponse(s.statusCode,i,s.headers)}catch(e){var u=e.response&&e.response.data?e.response.data:e.message||e;return d.httpResponse(500,u)}}))()}setFunctionContext(e,r){this.event=e,this.context=r,process.env.sourceIpAddress=e.requestContext&&e.requestContext.identity&&e.requestContext.identity.sourceIp?e.requestContext.identity.sourceIp:null}static httpResponse(e,r){return{statusCode:e,body:r,headers:p({"Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"*"},arguments.length>2&&void 0!==arguments[2]?arguments[2]:{})}}isAuthorized(){var e={header:this.authHeaderIsTheSameInTheEnvironment()}[this.env.authMethod];return void 0===e||e}authHeaderIsTheSameInTheEnvironment(){return this.event.headers.Authorization===this.env.authToken}}const v=function(){var e=r()((function*(e,r,t,n){var o=new class extends d{};return o[n]=t,o.handle(e,r,n)}));return function(r,t,n,o){return e.apply(this,arguments)}}(),h=require("axios");var f=t.n(h);const y=require("@babel/runtime/helpers/taggedTemplateLiteral");var g=t.n(y);const b=require("mssql");var m,O,w,j,C,q=t.n(b),P=function(){var e=r()((function*(){var e={user:process.env.DB_USER,password:process.env.DB_PWD,database:process.env.DB_NAME,server:process.env.DB_HOST,port:Number(process.env.DB_PORT),pool:{max:10,min:0,idleTimeoutMillis:3e4},options:{encrypt:!0,trustServerCertificate:!0}};return q().connect(e)}));return function(){return e.apply(this,arguments)}}(),S={get:(C=r()((function*(e){try{var r;yield P();var t=yield q().query(m||(m=g()(["select top 5 * from IGXMLDownload where Status = ",""])),e);return(null==t||null===(r=t.recordsets)||void 0===r?void 0:r.flat())||[]}catch(e){return console.log(e),null}})),function(e){return C.apply(this,arguments)}),getCert:function(){var e=r()((function*(e){try{var r;yield P();var t=yield q().query(O||(O=g()(["select top 1 Senha, RawData from IGCertificadoDigital where CNPJ_Contribuinte = ",""])),e);return(null==t||null===(r=t.recordsets)||void 0===r?void 0:r.flat())||[]}catch(e){return console.log(e),null}}));return function(r){return e.apply(this,arguments)}}(),update:(j=r()((function*(e,r){try{return yield P(),yield q().query(w||(w=g()(["update IGXMLDownload set Status = "," where ChaveAcessoDOC = ",""])),e,r)}catch(e){return console.log(e),null}})),function(e,r){return j.apply(this,arguments)})};const x=require("tough-cookie"),A=require("http-cookie-agent/http");var D=t(999);function E(){return(E=r()((function*(e){var r=yield S.getCert(e);if(!r||0===(null==r?void 0:r.length))throw new Error("Não foi localizado nunenhum certificado com esse cnpj: ",e);var t=(0,D.decrypt)(r[0].Senha),n=new x.CookieJar;return{httpsAgent:new A.HttpsCookieAgent({cookies:{jar:n},pfx:r[0].RawData,passphrase:t}),httpAgent:new A.HttpCookieAgent({cookies:{jar:n}})}}))).apply(this,arguments)}function T(){return T=r()((function*(e){var{url:r,key:t,cnpj:n}=e,{httpsAgent:o,httpAgent:a}=yield function(e){return E.apply(this,arguments)}(n),s=f().create({httpsAgent:o,httpAgent:a});r=(e=>(e.includes("&lp=")||(e+="&lp=L0l4L0hGSE1LMUtGeEJ5elpwTXNYeHRxOEx1RTA2SjhJMkludFZmZ0hvMFJITzBtaEdLK2YvbEFRYXFULzJJTlJyODhQNFVKakNDWTNhWm44NlpwNm9Ddkp2NTdiK3ZhQWFqSTdYQWJzN3M90"),e))(r);try{var i,u=yield s({url:r,method:"GET",maxRedirects:1,responseType:"text/xml"});if(!u.data)throw new Error("Não foi possível gerar o XML");if(null!==(i=u.data)&&void 0!==i&&i.includes("html"))throw S.update(1,t),new Error("Não foi possível gerar o XML");return Buffer.from(u.data,"utf-8")}catch(e){console.log(e)}})),T.apply(this,arguments)}const k=require("form-data");var N=t.n(k);function M(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function R(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?M(Object(t),!0).forEach((function(r){c()(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):M(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function I(){return(I=r()((function*(e,r){try{var t=new(N());t.append("file",e,{filename:"".concat(r,".xml")});var n={url:"".concat(process.env.BASE_URL_IG,"/Arquivo/Upload"),method:"POST",data:t,headers:R(R({},t.getHeaders()),{},{Authorization:"Bearer ".concat(process.env.AUTH_IG)}),cache:!1},{data:o}=yield f()(n);if(null==o||!o.resultado)throw new Error("Não foi possível salvar o arquivo na pasta");return S.update(3,r),o}catch(e){throw console.log(e),S.update(1,r),new Error(null==e?void 0:e.message)}}))).apply(this,arguments)}var L=function(){var e=r()((function*(e){var{body:r}=e;try{var t=function(e){if(!e)return{error:!0,message:"Faltando parâmetros obrigatórios"};var r=i.validate(e);return r.error?{error:!0,message:"O seguinte parâmetro está faltando ou incorreto: ".concat(r.error.details[0].path[0])}:{value:r.value,error:!1}}(JSON.parse(r));if(t.error)return o.badRequest({message:t.message});var n=yield function(e){return T.apply(this,arguments)}(t.value);if(!n)return o.badRequest({message:"Problemas ao gerar arquivo"});var a=yield function(e,r){return I.apply(this,arguments)}(n,t.value.key);return o.ok(a)}catch(e){return console.log(e),o.serverError({error:null==e?void 0:e.message,message:"Ocorreu um erro ao gerar o arquivo"})}}));return function(r){return e.apply(this,arguments)}}(),_=function(){var e=r()((function*(e,r){return v(e,r,L,"downloadXML")}));return function(r,t){return e.apply(this,arguments)}}()})(),module.exports=n})();
//# sourceMappingURL=index.js.map