(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{base64ToFile:()=>m,handle:()=>O});const r=require("@babel/runtime/helpers/asyncToGenerator");var n=e.n(r);class o{static ok(e){return{statusCode:200,body:e}}static created(e){return{statusCode:201,body:e}}static notFound(e){return{statusCode:404,body:e}}static badRequest(e){return{statusCode:400,body:e}}static serverError(e){return{statusCode:500,body:e}}}const s=require("@hapi/joi");var i=e.n(s),a=i().object({base64:i().string().required(),fileName:i().string().required(),client:i().string().required(),ano:i().string().required(),fileType:i().string().default("xml"),mes:i().string().valid("janeiro","fevereiro","março","abril","maio","junho","julho","agosto","setembro","outubro","novembro","dezembro").required()});const u=require("@babel/runtime/helpers/defineProperty");var c=e.n(u);function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach((function(t){c()(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}class p{constructor(){this.event=null,this.context=null,this.env=process.env}handle(e,t,r){var o=arguments,s=this;return n()((function*(){var n=!(o.length>3&&void 0!==o[3])||o[3];if(s.setFunctionContext(e,t),!(yield s.isAuthorized()))return p.httpResponse(401,JSON.stringify({statusCode:401,message:"Unauthorized!"}));try{var i=yield s[r](e);if(!n)return i;var a="string"==typeof i.body?i.body:JSON.stringify(i.body);return p.httpResponse(i.statusCode,a,i.headers)}catch(e){var u=e.response&&e.response.data?e.response.data:e.message||e;return p.httpResponse(500,u)}}))()}setFunctionContext(e,t){this.event=e,this.context=t,process.env.sourceIpAddress=e.requestContext&&e.requestContext.identity&&e.requestContext.identity.sourceIp?e.requestContext.identity.sourceIp:null}static httpResponse(e,t){return{statusCode:e,body:t,headers:d({"Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"*"},arguments.length>2&&void 0!==arguments[2]?arguments[2]:{})}}isAuthorized(){var e={header:this.authHeaderIsTheSameInTheEnvironment()}[this.env.authMethod];return void 0===e||e}authHeaderIsTheSameInTheEnvironment(){return this.event.headers.Authorization===this.env.authToken}}const f=function(){var e=n()((function*(e,t,r,n){var o=new class extends p{};return o[n]=r,o.handle(e,t,n)}));return function(t,r,n,o){return e.apply(this,arguments)}}(),y=require("aws-sdk");var v=e.n(y),b={getContentFile:(e,t)=>n()((function*(){var r={Bucket:e,Key:t};return(new(v().S3)).getObject(r).promise()}))(),sendFile(e,t){var r=arguments;return n()((function*(){var n=r.length>2&&void 0!==r[2]?r[2]:"public-read",o={Bucket:e.bucket,Key:e.caption,ContentType:e.contentType,ContentDisposition:e.contentDisposition,Body:e.buffer,ACL:n};return t&&(o.Expires=t),(new(v().S3)).upload(o).promise()}))()},listFiles:e=>n()((function*(){var t=new(v().S3),r={Bucket:e.bucket,Prefix:e.key};return t.listObjectsV2(r).promise()}))(),deleteFile:e=>n()((function*(){return(new(v().S3)).deleteObject(e).promise()}))()},h=(v().config.update({accessKeyId:process.env.accessKeyId,secretAccessKey:process.env.secretAccessKey,region:process.env.region}),b);function g(){return(g=n()((function*(e){var{fileName:t,client:r,ano:n,mes:o,base64:s,fileType:i}=e,a={bucket:"emalote",caption:"".concat(r,"/").concat(n,"/").concat(o,"/").concat(t,".").concat(i),contentType:"application/".concat(i),contentDisposition:"inline",buffer:Buffer.from(s,"base64")},u=yield h.sendFile(a);return u&&u.Location?u.Location:""}))).apply(this,arguments)}var m=function(){var e=n()((function*(e){var{body:t}=e;try{var r=function(e){if(!e)return{error:!0,message:"Faltando parâmetros obrigatórios"};var t=a.validate(e);return t.error?{error:!0,message:"O seguinte parâmetro está faltando ou incorreto: ".concat(t.error.details[0].path[0])}:{value:t.value,error:!1}}(JSON.parse(t));if(r.error)return o.badRequest({message:r.message});var n=yield function(e){return g.apply(this,arguments)}(r.value);return o.ok({file:n})}catch(e){return o.serverError({message:(null==e?void 0:e.message)||"Problemas ao gerar arquivo"})}}));return function(t){return e.apply(this,arguments)}}(),O=function(){var e=n()((function*(e,t){return f(e,t,m,"base64ToFile")}));return function(t,r){return e.apply(this,arguments)}}();module.exports=t})();
//# sourceMappingURL=index.js.map